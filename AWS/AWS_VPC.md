Amazon VPC 
====================================
## Summary
- Last Updated : 21.08.29 Sun   
- Updated by : YEONSUN YOON
-----------------------------------

# Amazon VPC
   
<img width="532" alt="스크린샷 2021-08-17 오전 2 31 50" src="https://user-images.githubusercontent.com/57285121/129605217-52c9faf1-c2d3-4861-ac5e-006c34a963be.png">
   
* Amazon VPC(Virtual Private Cloud)는 독립된 가상의 **클라우드 네트워크**입니다.
* VPC 리소스들을 사용하여 AWS 서비스들을 사용하기 위한 **네트워크 환경을 정의**할 수 있습니다.
* VPC의 IPv4 범위는 **CIDR 표기법**을 사용하여 표기합니다.   
> * CIDR(Classless Inder-Domain Routing) 표기법은 네트워크 부분 + 호스트 부분으로 구성된 32비트의 IPv4 주소에서 **네트워크 부분의 비트 길이를 숫자로 표기**하는 방법입니다.   
* VPC를 생성할 때 RFC 1918에 명시된 사설 IP 주소 대역의 IP를 사용합니다.   
   
|RFC 1918 Private IP|
|------|
|10.0.0.0 ~ 10.255.255.255(10.0.0.0/8 prefix)|
|172.16.0.0 ~ 172.31.255.255(172.16.0.0/12 prefix)|
|192.168.0.0 ~ 192.168.255.255(192.168.0.0/16 prefix)|
   
* 그러나 위 주소로 IPv4 CIDR 블록을 지정하고 VPC를 생성할 경우 에러가 발생합니다.
   
<img width="530" alt="스크린샷 2021-08-29 오후 1 13 42" src="https://user-images.githubusercontent.com/57285121/131238163-1149d6a6-012f-4bff-b9a5-f6c23f121ee1.png">
    
> * VPC IPv4 CIDR를 설정할 떄 CIDR 블록의 범위는 사설 IP 주소 대역 + `/16` ~ `/28` 입니다.   
> * 10.0.0.0/16, 172.16.0.0/16, 192.168.0.0/16, 이하의 CIDR 지정 가능
   
<img width="366" alt="스크린샷 2021-08-29 오후 1 14 56" src="https://user-images.githubusercontent.com/57285121/131238182-8af56b06-1fe1-43f3-9d0f-8257b933b482.png">
   
## 기본 VPC
   
<img width="1535" alt="스크린샷 2021-08-17 오전 2 36 20" src="https://user-images.githubusercontent.com/57285121/129605743-7a7d5115-a6f6-4f03-9f89-91696857564f.png">
   
* VPC는 기본(default) VPC와 사용자(custom) VPC로 구분할 수 있는데 VPC 대시보드에서 별 다른 생성을 안했다면 기본 VPC 하나만 남아있습니다.(Name : - ) 기본 VPC는 리전 별 1개씩 기본적으로 생성되어 있고 VPC 리소스가 미리 정해져 있습니다. 반면, 사용자 VPC는 리전 별 최대 5개(default)까지 생성이 가능하며 사용자가 네트워크 구성 환경에 맞게 수동으로 VPC 리소스를 설정해야 합니다.
* 기본 VPC의 IPv4 CIDR는 172.31.0.0/16 이고 리전내 가용영역마다 하나의 서브넷이 생성되어 있습니다.
* 기본 VPC는 사용하지 않는 것이 좋습니다.   
> * IPv4 CIDR의 대역이 고정적이고 EC2 인스턴스 생성시 default 설정으로 기본 VPC가 설정되어 있기 때문에 이런 불편함을 해결하기 위해서 삭제하거나 사용하지 않는 것이 좋습니다.

# Amazon VPC 리소스
   
<img width="441" alt="스크린샷 2021-08-17 오전 2 37 49" src="https://user-images.githubusercontent.com/57285121/129605918-220baed2-bb57-41f3-a64d-cc6763789108.png">
   
* AWS 관리 콘솔에서 VPC 대시보드를 통해 다양한 VPC 리소스들을 확인할 수 있습니다.

## 서브넷(Subnet)
   
<img width="379" alt="스크린샷 2021-08-17 오전 2 39 04" src="https://user-images.githubusercontent.com/57285121/129606056-09eedd36-3ddb-4e88-ae2b-d1d386088c29.png">
   
* 서브넷(subnet)이란 커다란 네트워크를 작은 단위로 분할하여 **서로 다른 네트워크 영역을 구별**하기 위한 망입니다.
* 직접 통신이 가능한 범위를 좁히고 방화벽을 설정해 보안을 강화하기 위해 사용합니다.
* VPC 내 서브넷들의 IP 대역은 **VPC의 IPv4 주소 범위 내에** 속해야만 하고 **하나 이상의 가용 영역에 연결**되어야 합니다.
* 서브넷의 IP 대역중 첫 번째 ~ 네 번째 주소(예를 들어 VPC IP 대역이 10.0.0.0/16이고 서브넷들의 IP 대역이 10.0.0.0/24일 경우 10.0.0.0/24 ~ 10.0.0.3/24)와 마지막 주소(서브넷 IP 대역 의 맨 끝 범위의 IP)는 **예약된 IP 주소**입니다.
* VPC 내 첫 번째 서브넷의 세 번째 주소는 DNS 서버 주소로 사용되고 나머지 서브넷들의 세 번째 주소는 AWS에서 예약되어 있습니다.
* 예약된 IP 주소
   
|Subnet IP|기능|
|------|---|
|첫 번째 주소|네트워크 주소|
|두 번째 주소|AWS VPC 가상 라우터 주소|
|세 번째 주소|AWS DNS 서버 주소|
|네 번째 주소|AWS 에서 앞으로 사용하기 위해 예약해둔 주소|
|다섯 번째 주소|브로드캐스트 주소|
   
### 퍼블릭(Public) & 프라이빗(Private) 서브넷
   
<img width="499" alt="스크린샷 2021-08-17 오후 12 48 35" src="https://user-images.githubusercontent.com/57285121/129660635-692c4d7e-d34a-4f5f-b0e8-eb567020b1cc.png">
   
* 퍼블릭(Public) 서브넷은 공공 IP를 사용하는 Public 네트워크의 개념입니다. Public 네트워크란 공공의 인터넷을 말하며 **외부의 인터넷과 직접적으로 통신할 수 있는 네트워크**를 말합니다.
* 프라이빗(Private) 서브넷은 사설 IP를 사용하는 Private 네트워크의 개념입니다. Private 네트워크란 폐쇄적인 사설 망을 말하며 **외부의 인터넷과 직접적인 통신이 불가능한 네트워크**를 말합니다. 프라이빗 서브넷은 외부와 통신이 불가능하지만 NAT 게이트웨이를 통해 공공 IP와 사설 IP간 변환 후 통신이 가능합니다.

## 가상 라우터 & 라우팅 테이블
   
<img width="595" alt="스크린샷 2021-08-17 오후 4 56 01" src="https://user-images.githubusercontent.com/57285121/129686820-0c9f5275-1ec5-4da9-bad5-7413641ed1f0.png">
   
* 가상 라우터는 물리적인 라우터가 아닌 소프트웨어로 구현된 라우터 입니다. 가상 라우터는 VPC생성 시 자동으로 생성되며 **라우팅 테이블을 참조하여 목적지로 패킷을 전송**합니다. 
* VPC 생성 시 최초 생성되는 가상 라우터는 기본 라우팅 테이블을 보유하고 있으며 로컬 망에 대한 라우팅 경로만 등록되어 있습니다.
* 라우팅 테이블에는 목적지들의 IP 주소가 등록되어 있으며 수신한 패킷의 목적지를 확인하고 목적지의 IP 주소가 라우팅 테이블에 존재하면 전송하고 그렇지 않으면 다른 라우터로 전송합니다.
* 가상 라우터를 통해 서브넷마다 각각 다른 라우팅 테이블을 연결할 수 있습니다. 특정 라우팅 테이블에 연결되어있지 않는 서브넷은 기본 라우팅 테이블에 연결됩니다.
* 서브넷 하나에는 하나의 라우팅 테이블만 연결할 수 있지만 여러 서브넷과 동일한 라우팅 테이블도 연결할 수 있습니다.(서브넷 하나에 여러 라우팅 테이블 연결 불가능)

## 인터넷 게이트웨이(IGW)
   
<img width="499" alt="스크린샷 2021-08-17 오후 5 06 34" src="https://user-images.githubusercontent.com/57285121/129688380-af730033-c82a-4c25-8571-82116238aece.png">
   
* VPC와 **인터넷과의 연결을 담당**합니다. 인터넷 게이트웨이는 VPC에서 인터넷으로 나가는 관문으로써 VPC와 인터넷과의 통신이 가능하도록 해줍니다. 또한 인스턴스의 프라이빗 IP와 퍼블릭 IP간 1:1 NAT 기능을 수행합니다.
* 인터넷 게이트웨아는 VPC당 1개만 생성 가능하며 VPC와 직접 연결합니다.
* 인터넷 게이트웨이는 외부의 인터넷과 통신을 담당하기 때문에 인터넷과 통신이 가능한 퍼블릭 서브넷과 연결합니다. 퍼블릭 서브넷의 라우팅 테이블에는 인터넷 게이트웨이가 등록되어 있어야 합니다. 
* 인터넷 게이트웨이는 퍼블릭 서브넷에서 외부 인터넷으로 나가는 트래픽(Outbound), 인터넷에서 퍼블릭 서브넷으로 들어오는 트래픽(Inbound) 둘 다 허용합니다.**(양방향)**

### 퍼블릭 서브넷의 통신과정
   
<img width="631" alt="스크린샷 2021-08-17 오후 5 17 00" src="https://user-images.githubusercontent.com/57285121/129689961-f847f12f-3c7b-474b-b698-37be6f5f68ba.png">
   
1. 퍼블릭 서브넷 내 EC2 인스턴스(퍼블릭 IP)가 가상 라우터로 데이터 전송
2. 가상 라우터는 퍼블릭 라우팅 테이블에서 인터넷 게이트웨이의 라우팅 정보가 등록되어 있는지 확인 후 인터넷 게이트웨이에 데이터 전송
3. 인터넷 게이트웨이를 거쳐 
4. 인터넷을 타고 사용자에게 데이터 전송

### 인터넷 게이트웨이를 통한 외부 인터넷 통신 과정
   
<img width="783" alt="스크린샷 2021-08-17 오후 5 21 44" src="https://user-images.githubusercontent.com/57285121/129690712-23789eae-1c2a-4c34-9465-1d73e0ee2a82.png">
   
1. EC2 인스턴스의 프라이빗 IP(10.0.0.10)에서 특정 웹서버(60.1.1.1)에 정보를 요청합니다.(원본 Source IP : 10.0.0.10, Destination IP : 60.1.1.1)
2. 인스턴스의 요청을 받은 인터넷 게이트웨이는 Source IP(인스턴스의 프라이빗 IP)를 퍼블릭 IP(50.1.1.1)로 변환합니다.(NAT)
3. 웹서버에는 Source IP : 50.1.1.1, Destination IP : 60.1.1.1의 요청이 도착하고 웹서버는 Source IP와 Destination IP를 바꾸고 요청에 대한 응답을 보냅니다.
4. 인터넷 게이트웨이는 다시 NAT 기능을 통해 응답의 Destination IP에 맞는 인스턴스의 프라이빗 IP로 변환한 후 응답을 인스턴스에게 전송합니다.

## NAT 게이트웨이

<img width="466" alt="스크린샷 2021-08-17 오후 5 23 36" src="https://user-images.githubusercontent.com/57285121/129690955-b1dea5bb-5236-4926-86ac-38bc86a903a8.png">
   
* NAT 게이트웨이도 인터넷 게이트웨이처럼 외부 인터넷과의 연결을 담당합니다.
* NAT(Network Address Translation)기술을 사용하여 IP 주소를 변환하여 외부와 통신이 가능하다는 점은 인터넷 게이트웨이와 같지만 NAT 게이트웨이는 **아웃바운드 트래픽만 허용**하고 **인바운드 트래픽은 거부**합니다.
* 기본적으로 프라이빗 서브넷 내의 프라이빗 IP로는 외부의 인터넷과 통신이 불가능합니다.(인터넷과 통신하기 위해서는 퍼블릭 IP가 필요합니다.) 하지만 필요에 의해 외부 인터넷과 통신이 필요할 경우 **프라이빗 IP를 NAT 게이트웨이가 퍼블릭 IP로 변환**하여 외부 인터넷과 통신을 가능하도록 해줍니다.

### NAT 게이트웨이 유형
   
<img width="614" alt="스크린샷 2021-08-17 오후 5 54 25" src="https://user-images.githubusercontent.com/57285121/129695537-90549af3-9a96-4f92-9bda-677fc64bcd6b.png">
   
* NAT 게이트웨이의 유형에는 퍼블릭(Public) / 프라이빗(Private) 두 유형이 있습니다.
* 퍼블릭(Default) : 프라이빗 서브넷 내 인스턴스와 연결하여 인스턴스와 인터넷 간 통신을 가능하도록 도와줍니다. 퍼블릭 서브넷 내에서 퍼블릭 NAT 게이트웨이를 생성할 때 Elastic IP(EIP)를 설정하면 NAT 게이트웨이로 들어오는 인바운드 트래픽을 인터넷 게이트웨이로 라우팅합니다.
* 프라이빗 : 프라이빗 NAT 게이트웨이는 Elastic IP를 설정할 수 없습니다. 프라이빗 NAT 게이트웨이는 외부 인터넷과 통신할 수 없습니다. (프라이빗 NAT 게이트웨이를 VPC에 연결된 인터넷 게이트웨이와 연결하면 인터넷 게이트웨이가 프라이빗 NAT 게이트웨이로부터의 트래픽을 삭제합니다.) 또한 외부 인터넷과 연결을 필요로 하지 않을 경우 인터넷 게이트웨이 필요 없이 프라이빗 NAT 게이트웨이를 사용하여 다른 VPC나 온프레미스와 연결할 수 있습니다.(프라이빗 통신만을 위해서 인터넷 게이트웨이에 대한 NAT 게이트웨이의 종속성 제거)

### NAT 게이트웨이를 통한 외부 인터넷 통신 과정
   
<img width="790" alt="스크린샷 2021-08-23 오전 1 50 28" src="https://user-images.githubusercontent.com/57285121/130363338-4b022991-cc65-4061-84b9-b5e2444ad88b.png">
   
1. 프라이빗 서브넷(10.40.2.0/24)의 EC2 T2 인스턴스(10.40.2.101)에서 인터넷의 웹서버(60.1.1.1)에 접속 요청을 합니다. **프라이빗 서브넷의 라우팅 테이블에 등록된 NAT 게이트웨이로 트래픽을 전송**합니다.
2. 트래픽을 수신한 NAT 게이트웨이는 **IP 마스커레이드(프라이빗 IP와 퍼블릭 IP간 주소 변환이 1:1이 아닌 1:n 변환 + 포트번호 포함)**기능을 통해 Source IP(10.40.2.101)를 퍼블릭 서브넷의 IPv4 CIDR 대역 내 IP(로 변환하고 NAT 정보에 기록한 후 퍼블릭 서브넷의 라우팅 테이블에 등록된 인터넷 게이트웨이로 트래픽을 전송합니다.
3. 인터넷 게이트웨이는 수신한 트래픽의 Source IP(10.40.1.100)을 NAT 기능을 통해 퍼블릭 IPv4 주소 혹은 Elastic IP(a.b.c.d)로 변환 후 웹서버에 전송합니다. (이때 Source IP : a.b.c.d, Destination IP : 60.1.1.1)
4. 인터넷의 웹서버에서 Source IP와 Destination IP를 바꾼 후 인터넷 게이트웨이에 요청에 대한 응답을 전송합니다.(이때 Source IP : 60.1.1.1, Destination IP : a.b.c.d)
5. 인터넷 게이트웨이는 NAT 정보에 따라 수신한 트래픽의 Destination IP를 변환(a.b.c.d -> 10.40.1.100)하고 NAT 게이트웨이에 전송합니다.
6. NAT 게이트웨이는 Destination IP를 최초의 Source IP(10.40.2.101)로 변환합니다.
7. 프라이빗 서브넷 내 EC2 T2 인스턴스에 정상적으로 응답이 도착합니다.

## 탄력적 IP
   
<img width="638" alt="스크린샷 2021-08-23 오전 2 16 18" src="https://user-images.githubusercontent.com/57285121/130364055-41246c27-67a4-4846-9ecf-bbb793b15aa0.png">
   
* 탄력적 IP 주소(Elastic IP, EIP)는 동적인 클라우드 컴퓨팅을 위한 **고정 퍼블릭 IPv4 주소**입니다.
* VPC 내의 인스턴스와 네트워크 인터페이스에 탄력적 IP 주소를 할당할 수 있습니다.
* 인스턴스 중지 후 재시작할 경우에 IPv4 주소가 바뀌게 되는데 탄력적 IP 주소를 사용하게 되면 **인스턴스의 IPv4 주소가 바뀌지 않습니다.**
* 탄력적 IP 주소는 AWS 계정에 연결되어 있습니다. 계정 내 확보한 IPv4 주소를 인스턴스나 네트워크 인터페이스에 할당할 수 있습니다.
* 탄력적 IP 주소를 할당받고 사용하지 않으면 비용이 청구됩니다. **(한정된 퍼블릭 IPv4 주소를 효율적으로 사용하기 위해서)**

## 보안 그룹 & 네트워크 ACL
   
<img width="595" alt="스크린샷 2021-08-23 오전 2 38 00" src="https://user-images.githubusercontent.com/57285121/130364617-cb599b6c-df73-424c-84ee-ea367c28a24d.png">
   
* 보안 그룹(Security Group)과 네트워크 ACL(Access Control List)은 VPC 내 서브넷과 인스턴스에 대한 인바운드/아웃바운드 트래픽의 허용 및 거부 규칙을 제어하는 가상의 **방화벽**역할을 합니다.
* 보안 그룹은 **인스턴스에 대한 접근 규칙**을 설정합니다. 인스턴스 하나당 최대 5개의 보안 그룹을 설정할 수 있습니다.
* 보안그룹은 인바운드/아웃바운드 트래픽에 대해 **허용할 규칙만 지정**할 수 있습니다.
* 네트워크 ACL은 **서브넷에 대한 접근 규칙**을 설정합니다. 서브넷 단위로 접근 규칙을 설정하기 때문에 인스턴스마다 개별적으로 접근 규칙을 설정할 필요가 없습니다.
* 인바운드/아웃바운드 규칙은 적용할 **프로토콜**과 **포트번호**단위로 접근 규칙을 설정합니다. 포트번호는 **Well-Known Port**를 사용합니다.
   
|항목|보안 그룹|네트워크 ACL|
|------|---|---|
|설정 범위|**인스턴스** 단위|**서브넷** 단위|
|트래픽 흐름 제어|Inbound All Deny, Outbound All Allow|Inbound, Outbound All Allow|
|규칙|접근 규칙 허용만 가능(모두 차단, 허용할 규칙 생성하여 허용)|접근 규칙 허용/거부 둘 다 가능(모두 허용, 차단할 규칙 생성하여 차단)|
|트래픽 허용 방식|**Stateful**|**Stateless**|
   
Well-Known Port
* SSH : 22
* HTTP : 80
* HTTPS : 443
* SMTP : 25(메일 송신)
* POP3 : 110(메일 수신)
* FTP : 20, 21
* DNS : 53

### Stateful / Stateless
* Stateful : 요청 정보를 저장하여 **인바운드 규칙에 따라 허용된 트래픽은 별도의 아웃바운드 규칙 없이도 인바운드 트래픽의 요청에 응답할 수 있습니다.**   
> * Ex) 인바운드 규칙에 http 80번 포트가 허용되어 있으면 아웃바운드 규칙 설정 없이도 요청에 응답할 수 있습니다.   
* Stateless : 요청 정보를 따로 저장하지 않기 때문에 응답하는 트래픽의 상태과 상관없이 인바운드/아웃바운드 규칙을 따릅니다. 허용되는 인바운드 트래픽에 대한 응답은 **인바운드 규칙에 상관없이 아웃바운드 규칙을 따릅니다.**   
> * Ex) 인바운드 규칙에 http 80번 포트가 허용되어 있더라도 아웃바운드 규칙에 http 80번 포트가 허용되어 있지 않으면 요청에 응답할 수 없습니다.

